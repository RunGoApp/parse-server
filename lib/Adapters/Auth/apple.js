'use strict';

// Apple SignIn Auth
// https://developer.apple.com/documentation/signinwithapplerestapi

const Parse = require('parse/node').Parse;
const httpsRequest = require('./httpsRequest');
const NodeRSA = require('node-rsa');
const jwt = require('jsonwebtoken');

const TOKEN_ISSUER = 'https://appleid.apple.com';

let currentKey;

const getApplePublicKey = async keyID => {
  let data;
  try {
    data = await httpsRequest.get('https://appleid.apple.com/auth/keys');
  } catch (e) {
    if (currentKey) {
      return currentKey;
    }
    throw e;
  }

  const key = data.keys.find(key => key.kid === keyID);

  if (!key) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `Public key with matching key ID to token not found`);
  }

  const pubKey = new NodeRSA();
  pubKey.importKey({ n: Buffer.from(key.n, 'base64'), e: Buffer.from(key.e, 'base64') }, 'components-public');

  currentKey = pubKey.exportKey(['public']);
  return currentKey;
};

const getKeyAndAlgoFromToken = token => {
  const decodedToken = jwt.decode(token, {
    complete: true
  });
  if (!decodedToken) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `provided token does not decode as JWT`);
  }

  const keyID = decodedToken.header.kid;
  const algo = decodedToken.header.alg;

  return { keyID, algo };
};

const verifyIdToken = async ({ token, id }, clientID) => {
  if (!token) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, 'id token is invalid for this user.');
  }

  const decodedToken = getKeyAndAlgoFromToken(token);
  const applePublicKey = await getApplePublicKey(decodedToken.keyID);
  let jwtClaims;

  try {
    jwtClaims = jwt.verify(token, applePublicKey, {
      algorithms: decodedToken.algo
    });
  } catch (exception) {
    const message = exception.message;
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `${message}`);
  }

  if (jwtClaims.iss !== TOKEN_ISSUER) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `id token not issued by correct OpenID provider - expected: ${TOKEN_ISSUER} | from: ${jwtClaims.iss}`);
  }

  if (jwtClaims.sub !== id) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `auth data is invalid for this user.`);
  }

  if (!clientID) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `client ids do not exist`);
  }

  if (typeof clientID === "string") clientID = [clientID];

  if (!Array.isArray(clientID)) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `invalid client id type provided, either string or array`);
  }

  if (clientID.length === 0) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `need at least one client id, empty array provided`);
  }

  if (!clientID.includes(jwtClaims.aud)) {
    throw new Parse.Error(Parse.Error.OBJECT_NOT_FOUND, `jwt aud parameter does not include this client - is: ${jwtClaims.aud} | expected: ${clientID}`);
  }
  return jwtClaims;
};

// Returns a promise that fulfills if this id token is valid
function validateAuthData(authData, options = {}) {
  return verifyIdToken(authData, options.client_id);
}

// Returns a promise that fulfills if this app id is valid.
function validateAppId() {
  return Promise.resolve();
}

module.exports = {
  validateAppId,
  validateAuthData
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9BZGFwdGVycy9BdXRoL2FwcGxlLmpzIl0sIm5hbWVzIjpbIlBhcnNlIiwicmVxdWlyZSIsImh0dHBzUmVxdWVzdCIsIk5vZGVSU0EiLCJqd3QiLCJUT0tFTl9JU1NVRVIiLCJjdXJyZW50S2V5IiwiZ2V0QXBwbGVQdWJsaWNLZXkiLCJrZXlJRCIsImRhdGEiLCJnZXQiLCJlIiwia2V5Iiwia2V5cyIsImZpbmQiLCJraWQiLCJFcnJvciIsIk9CSkVDVF9OT1RfRk9VTkQiLCJwdWJLZXkiLCJpbXBvcnRLZXkiLCJuIiwiQnVmZmVyIiwiZnJvbSIsImV4cG9ydEtleSIsImdldEtleUFuZEFsZ29Gcm9tVG9rZW4iLCJ0b2tlbiIsImRlY29kZWRUb2tlbiIsImRlY29kZSIsImNvbXBsZXRlIiwiaGVhZGVyIiwiYWxnbyIsImFsZyIsInZlcmlmeUlkVG9rZW4iLCJpZCIsImNsaWVudElEIiwiYXBwbGVQdWJsaWNLZXkiLCJqd3RDbGFpbXMiLCJ2ZXJpZnkiLCJhbGdvcml0aG1zIiwiZXhjZXB0aW9uIiwibWVzc2FnZSIsImlzcyIsInN1YiIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsImluY2x1ZGVzIiwiYXVkIiwidmFsaWRhdGVBdXRoRGF0YSIsImF1dGhEYXRhIiwib3B0aW9ucyIsImNsaWVudF9pZCIsInZhbGlkYXRlQXBwSWQiLCJQcm9taXNlIiwicmVzb2x2ZSIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUE7QUFDQTs7QUFFQSxNQUFNQSxRQUFRQyxRQUFRLFlBQVIsRUFBc0JELEtBQXBDO0FBQ0EsTUFBTUUsZUFBZUQsUUFBUSxnQkFBUixDQUFyQjtBQUNBLE1BQU1FLFVBQVVGLFFBQVEsVUFBUixDQUFoQjtBQUNBLE1BQU1HLE1BQU1ILFFBQVEsY0FBUixDQUFaOztBQUVBLE1BQU1JLGVBQWUsMkJBQXJCOztBQUVBLElBQUlDLFVBQUo7O0FBRUEsTUFBTUMsb0JBQW9CLE1BQU1DLEtBQU4sSUFBZTtB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aWduSW4gQXV0aFxuLy8gaHR0cHM6Ly9kZXZlbG9wZXIuYXBwbGUuY29tL2RvY3VtZW50YXRpb24vc2lnbmlud2l0aGFwcGxlcmVzdGFwaVxuXG5jb25zdCBQYXJzZSA9IHJlcXVpcmUoJ3BhcnNlL25vZGUnKS5QYXJzZTtcbmNvbnN0IGh0dHBzUmVxdWVzdCA9IHJlcXVpcmUoJy4vaHR0cHNSZXF1ZXN0Jyk7XG5jb25zdCBOb2RlUlNBID0gcmVxdWlyZSgnbm9kZS1yc2EnKTtcbmNvbnN0IGp3dCA9IHJlcXVpcmUoJ2pzb253ZWJ0b2tlbicpO1xuXG5jb25zdCBUT0tFTl9JU1NVRVIgPSAnaHR0cHM6Ly9hcHBsZWlkLmFwcGxlLmNvbSc7XG5cbmxldCBjdXJyZW50S2V5O1xuXG5jb25zdCBnZXRBcHBsZVB1YmxpY0tleSA9IGFzeW5jIGtleUlEID0+IHtcbiAgbGV0IGRhdGE7XG4gIHRyeSB7XG4gICAgZGF0YSA9IGF3YWl0IGh0dHBzUmVxdWVzdC5nZXQoJ2h0dHBzOi8vYXBwbGVpZC5hcHBsZS5jb20vYXV0aC9rZXlzJyk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBpZiAoY3VycmVudEtleSkge1xuICAgICAgcmV0dXJuIGN1cnJlbnRLZXk7XG4gICAgfVxuICAgIHRocm93IGU7XG4gIH1cblxuICBjb25zdCBrZXkgPSBkYXRhLmtleXMuZmluZChrZXkgPT4ga2V5LmtpZCA9PT0ga2V5SUQpO1xuXG4gIGlmICgha2V5KSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgIGBQdWJsaWMga2V5IHdpdGggbWF0Y2hpbmcga2V5IElEIHRvIHRva2VuIG5vdCBmb3VuZGBcbiAgICApO1xuICB9XG5cbiAgY29uc3QgcHViS2V5ID0gbmV3IE5vZGVSU0EoKTsgIFxuICBwdWJLZXkuaW1wb3J0S2V5KFxuICAgIHsgbjogQnVmZmVyLmZyb20oa2V5Lm4sICdiYXNlNjQnKSwgZTogQnVmZmVyLmZyb20oa2V5LmUsICdiYXNlNjQnKSB9LFxuICAgICdjb21wb25lbnRzLXB1YmxpYydcbiAgKTtcbiAgXG4gIGN1cnJlbnRLZXkgPSBwdWJLZXkuZXhwb3J0S2V5KFsncHVibGljJ10pO1xuICByZXR1cm4gY3VycmVudEtleTtcbn07XG5cbmNvbnN0IGdldEtleUFuZEFsZ29Gcm9tVG9rZW4gPSB0b2tlbiA9PiB7XG4gIGNvbnN0IGRlY29kZWRUb2tlbiA9IGp3dC5kZWNvZGUodG9rZW4sXG4gICAge1xuICAgICAgY29tcGxldGU6IHRydWVcbiAgICB9XG4gICk7XG4gIGlmICghZGVjb2RlZFRva2VuKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgIGBwcm92aWRlZCB0b2tlbiBkb2VzIG5vdCBkZWNvZGUgYXMgSldUYFxuICAgICk7XG4gIH1cblxuICBjb25zdCBrZXlJRCA9IGRlY29kZWRUb2tlbi5oZWFkZXIua2lkO1xuICBjb25zdCBhbGdvID0gZGVjb2RlZFRva2VuLmhlYWRlci5hbGc7XG5cbiAgcmV0dXJuIHsga2V5SUQsIGFsZ28gfTtcbn1cblxuY29uc3QgdmVyaWZ5SWRUb2tlbiA9IGFzeW5jICh7IHRva2VuLCBpZCB9LCBjbGllbnRJRCkgPT4ge1xuICBpZiAoIXRva2VuKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgICdpZCB0b2tlbiBpcyBpbnZhbGlkIGZvciB0aGlzIHVzZXIuJ1xuICAgICk7XG4gIH1cblxuICBjb25zdCBkZWNvZGVkVG9rZW4gPSBnZXRLZXlBbmRBbGdvRnJvbVRva2VuKHRva2VuKTtcbiAgY29uc3QgYXBwbGVQdWJsaWNLZXkgPSBhd2FpdCBnZXRBcHBsZVB1YmxpY0tleShkZWNvZGVkVG9rZW4ua2V5SUQpO1xuICBsZXQgand0Q2xhaW1zO1xuICBcbiAgdHJ5IHtcbiAgICBqd3RDbGFpbXMgPSBqd3QudmVyaWZ5KHRva2VuLCBhcHBsZVB1YmxpY0tleSwge1xuICAgICAgYWxnb3JpdGhtczogZGVjb2RlZFRva2VuLmFsZ28sXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGV4Y2VwdGlvbikge1xuICAgIGNvbnN0IG1lc3NhZ2UgPSBleGNlcHRpb24ubWVzc2FnZTtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCwgYCR7bWVzc2FnZX1gKTtcbiAgfVxuXG4gIGlmIChqd3RDbGFpbXMuaXNzICE9PSBUT0tFTl9JU1NVRVIpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgYGlkIHRva2VuIG5vdCBpc3N1ZWQgYnkgY29ycmVjdCBPcGVuSUQgcHJvdmlkZXIgLSBleHBlY3RlZDogJHtUT0tFTl9JU1NVRVJ9IHwgZnJvbTogJHtqd3RDbGFpbXMuaXNzfWBcbiAgICApO1xuICB9XG5cbiAgaWYgKGp3dENsYWltcy5zdWIgIT09IGlkKSB7XG4gICAgdGhyb3cgbmV3IFBhcnNlLkVycm9yKFxuICAgICAgUGFyc2UuRXJyb3IuT0JKRUNUX05PVF9GT1VORCxcbiAgICAgIGBhdXRoIGRhdGEgaXMgaW52YWxpZCBmb3IgdGhpcyB1c2VyLmBcbiAgICApO1xuICB9XG5cbiAgaWYgKCFjbGllbnRJRCkge1xuICAgIHRocm93IG5ldyBQYXJzZS5FcnJvcihcbiAgICAgIFBhcnNlLkVycm9yLk9CSkVDVF9OT1RfRk9VTkQsXG4gICAgICBgY2xpZW50IGlkcyBkbyBub3QgZXhpc3RgXG4gICAgKTtcbiAgfVxuXG4gIGlmICh0eXBlb2YgY2xpZW50SUQgPT09IFwic3RyaW5nXCIpXG4gICAgY2xpZW50SUQgPSBbY2xpZW50SURdO1xuXG4gIGlmICghQXJyYXkuaXNBcnJheShjbGllbnRJRCkpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgYGludmFsaWQgY2xpZW50IGlkIHR5cGUgcHJvdmlkZWQsIGVpdGhlciBzdHJpbmcgb3IgYXJyYXlgXG4gICAgKTtcbiAgfVxuXG4gIGlmIChjbGllbnRJRC5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgYG5lZWQgYXQgbGVhc3Qgb25lIGNsaWVudCBpZCwgZW1wdHkgYXJyYXkgcHJvdmlkZWRgXG4gICAgKTtcbiAgfVxuXG4gIGlmICghY2xpZW50SUQuaW5jbHVkZXMoand0Q2xhaW1zLmF1ZCkpIHtcbiAgICB0aHJvdyBuZXcgUGFyc2UuRXJyb3IoXG4gICAgICBQYXJzZS5FcnJvci5PQkpFQ1RfTk9UX0ZPVU5ELFxuICAgICAgYGp3dCBhdWQgcGFyYW1ldGVyIGRvZXMgbm90IGluY2x1ZGUgdGhpcyBjbGllbnQgLSBpczogJHtqd3RDbGFpbXMuYXVkfSB8IGV4cGVjdGVkOiAke2NsaWVudElEfWBcbiAgICApO1xuICB9XG4gIHJldHVybiBqd3RDbGFpbXM7XG59O1xuXG4vLyBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IGZ1bGZpbGxzIGlmIHRoaXMgaWQgdG9rZW4gaXMgdmFsaWRcbmZ1bmN0aW9uIHZhbGlkYXRlQXV0aERhdGEoYXV0aERhdGEsIG9wdGlvbnMgPSB7fSkge1xuICByZXR1cm4gdmVyaWZ5SWRUb2tlbihhdXRoRGF0YSwgb3B0aW9ucy5jbGllbnRfaWQpO1xufVxuXG4vLyBSZXR1cm5zIGEgcHJvbWlzZSB0aGF0IGZ1bGZpbGxzIGlmIHRoaXMgYXBwIGlkIGlzIHZhbGlkLlxuZnVuY3Rpb24gdmFsaWRhdGVBcHBJZCgpIHtcbiAgcmV0dXJuIFByb21pc2UucmVzb2x2ZSgpO1xufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgdmFsaWRhdGVBcHBJZCxcbiAgdmFsaWRhdGVBdXRoRGF0YSxcbn07XG4iXX0=